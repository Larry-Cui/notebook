---
layout: post
title: "Section 4: Under the Hood"
date: 2024-12-29
draft: false
categories:
  - Computer
tags:
  - Node.js
---

## V8 and others

`node.js` dependencies are libraries that `node.js` depends on to work properly.

Two of the most important dependencies are "**V8**" engine and "**libuv**", a open source library focusing on "asynchronous IO". Both dependencies are basically written in `c++`.

## Processes and Threads

`node.js` is just running in "**ONE**" thread.

"**libuv**" gives us additional 4 or more threads by "Thread Pool". "Thread Pool" will be dealing with heavy tasks, like FS APIs, Cryptography, Compression, DNS lookups, that automatically offloaded to it by "Event Loop".

## Event Loop

It is all the application code that is inside call-back function, a function that is called as soon as some tasks are finished.

Some types of callback functions:

- Expired Timer Callbacks
  > ```js
  > setTimeout(() => console.log("time out!"));
  > ```
- I/O Polling and Callbacks
  > ```js
  > fs.readFile("file.txt", (error, data) => console.log("file read!"));
  > ```
- setImmediate callbacks
- Close callbacks

Please also see [this slide](../slides/theory-lectures-dragged.pdf){:target="\_blank"}.

==Don't Block==

- :fontawesome-regular-hand-point-right: Don's use sync version of functions in `fs`, `crypto` and `zlib` modules
- :fontawesome-regular-hand-point-right: Don's perform complex calcuations
- :fontawesome-regular-hand-point-right: Be careful with `json` with large objects
- :fontawesome-regular-hand-point-right: Don's use complex regular expression

Guess the sequence of the following code execution?

```js
const fs = require("fs");
setImmediate(() => console.log("Immediate 1 finished!"));
setTimeout(() => console.log("Timer 2 finished!"), 50);
setTimeout(() => console.log("Timer 1 finished!"), 0);
fs.readFile("test-file.txt", () => console.log("I/O finished!"));
console.log("Hello from the top level code!");
```

Result:

```
Hello from the top level code!
Timer 1 finished!
Immediate 1 finished!
I/O finished!
Timer 2 finished!
```

Heavy jobs are offloaded to "thread pool" by multiple processing. Usually there are 4 threads in the pool, but we can change the pool size.

`process.env.UV_THREADPOOL_SIZE = 10`

## Event-driven Architecture
